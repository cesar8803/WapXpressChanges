(function($){var getAttribute=function(record,attrName,defaultVal){if(record!=null&&attrName!=null&&record.attributes!=null&&record.attributes[attrName]!=null){return record.attributes[attrName][0];}return(typeof(defaultVal)==="undefined"?null:defaultVal);};var getServletPath=function(){return"/"+window.location.pathname.split("/")[1];};$.EndecaSearchSuggestor=function(ele,opts){this._active=true;this._options=opts;this._lastValue="";this._element=ele;this._container=$('<div class="'+this._options.containerClass+'"></>');this._timeOutId;this._hideTimeOutId;this._selectedIndex=-1;var suggestor=this;$("body").append(this._container);ele.keydown(function(e){switch(e.keyCode){case 38:if(suggestor._active){suggestor.moveToPrev();}else{suggestor.show();}break;case 40:if(suggestor._active){suggestor.moveToNext();}else{suggestor.show();}break;case 9:suggestor.hide();break;case 13:if(suggestor._active&&suggestor._selectedIndex!=-1){e.preventDefault();suggestor.selectItem();return false;}break;case 27:if(suggestor._active){suggestor.hide();}break;default:suggestor.handleRequest();}});ele.blur(function(e){var hideFunction=function(){suggestor.hide();};suggestor._hideTimeOutId=setTimeout(hideFunction,200);});};$.EndecaSearchSuggestor.prototype.moveToPrev=function(){if(this._selectedIndex==-1){this._selectedIndex=0;}else{if(this._selectedIndex==0){return;}this._selectedIndex--;}$(".type-line").removeClass("selected");$($(".type-line").get(this._selectedIndex)).addClass("selected");};$.EndecaSearchSuggestor.prototype.moveToNext=function(){if(this._selectedIndex==-1){this._selectedIndex=0;}else{if(this._selectedIndex==$(".type-line").size()-1){return;}this._selectedIndex++;}$(".type-line").removeClass("selected");$($(".type-line").get(this._selectedIndex)).addClass("selected");};$.EndecaSearchSuggestor.prototype.selectItem=function(){if(this._selectedIndex==-1){return;}var url=$("a",$(".type-line").get(this._selectedIndex)).attr("href");document.location.href=url;};$.EndecaSearchSuggestor.prototype.hide=function(){this._container.hide();this._active=false;};$.EndecaSearchSuggestor.prototype.show=function(){if(this._container.is(":hidden")){this.setPosition();this._container.show();this._active=true;this._selectedIndex=-1;}};$.EndecaSearchSuggestor.prototype.handleRequest=function(){var suggestor=this;var callback=function(){var text=$.trim(suggestor._element.val());if(text!=suggestor._lastValue){if(text.length>=suggestor._options.minAutoSuggestInputLength){suggestor.requestData();}else{suggestor.hide();$("div#typeahead").hide();}}suggestor._lastValue=text;};if(this._timeOutId){clearTimeout(this._timeOutId);}this._timeOutId=setTimeout(callback,this._options.delay);};$.EndecaSearchSuggestor.prototype.requestData=function(){var suggestor=this;var response=$.ajax({url:suggestor.composeUrl(),dataType:"json",async:true,contentType:"application/json",success:function(data){suggestor.showSearchResult(data);}});};$.EndecaSearchSuggestor.prototype.composeUrl=function(){var url=this._options.autoSuggestServiceUrl;var searchTerm=$.trim(this._element.val());var filter=$("#combo option:selected").val();console.log(filter);var N=0;if(filter!=null){N=filter;url+="?Dy=1&collection="+this._options.collection+"&N="+N+"&Ntx=mode+matchallpartial"+"&Ntt="+searchTerm+"*";}else{url+="?Dy=1&collection="+this._options.collection+"&Ntx=mode+matchallpartial"+"&Ntt="+searchTerm+"*";}console.log(url);return url;};$.EndecaSearchSuggestor.prototype.showSearchResult=function(data){var htmlResult=this.processSearchResult(data);if(htmlResult!=null){$("#typeahead").html(htmlResult);$("#typeahead").show();this.bindEventHandler();this.show();}else{this.hide();}};$.EndecaSearchSuggestor.prototype.processSearchResult=function(data){var dimSearchResult=null;var recordSearchResult=null;var autoSuggestCartridges=data.contents[0].autoSuggest;if(autoSuggestCartridges==null||autoSuggestCartridges.length==0){return null;}for(var j=0;j<autoSuggestCartridges.length;j++){var cartridge=autoSuggestCartridges[j];if(cartridge["@type"]=="DimensionSearchAutoSuggestItem"){dimSearchResult=cartridge;}}if(dimSearchResult!=null){return this.generateHtmlContent(dimSearchResult);}return null;};$.EndecaSearchSuggestor.prototype.generateHtmlContent=function(dimSearchResult){var newContent=$('<div id="type-main-list"></div>');var selectedCat=$("#combo option:selected").text();var selectedValue=$("#combo option:selected").val();if(dimSearchResult!=null&&dimSearchResult.dimensionSearchGroups.length>0){var dimSearchGroupList=dimSearchResult.dimensionSearchGroups;for(var i=0;i<dimSearchGroupList.length;i++){var dimResultGroup=dimSearchGroupList[i];var displayName=dimResultGroup.displayName;if(dimResultGroup!=null&&dimResultGroup.displayName=="product.brand"){for(var j=0;j<dimResultGroup.dimensionSearchValues.length;j++){var dimResult=dimResultGroup.dimensionSearchValues[j];var action=dimResult.navigationState;var count=dimResult.count;var text=dimResult.label;var ancestors=dimResult.ancestors;var ancestorsStr="";for(var n=0;n<ancestors.length;n++){ancestorsStr+=ancestors[n].label+" > ";}newContent.append('<div class="type-line"><a href="'+this._options.searchUrl+action+'" rel="external">'+ancestorsStr+this.highlightMatched(text)+"</a>"+"&nbsp("+count+")</div>");}}if(dimResultGroup!=null&&dimResultGroup.displayName=="product.category"){for(var j=0;j<dimResultGroup.dimensionSearchValues.length;j++){var dimResult=dimResultGroup.dimensionSearchValues[j];var action=dimResult.navigationState;var count=dimResult.count;var text=dimResult.label;var ancestors=dimResult.ancestors;var ancestorsStr="Home>";for(var n=0;n<ancestors.length;n++){ancestorsStr+=ancestors[n].label+" > ";}var catName=dimResult.label;if(ancestors.length==0){var stringFormatter=catName.replace(/([~!@#$%^&*()_+=`{}\[\]\|\\:;'<>,.\/? ])+/g,"-").replace(/^(-)+|(-)+$/g,"");stringFormatter=stringFormatter.toLowerCase();var action="/"+stringFormatter+"/"+dimResult.properties["category.repositoryId"];}else{action=action.substring(1);var restString=action.substring(action.indexOf("/"));action=action.substring(0,action.indexOf("/"));var stringFormatter=catName.replace(/([~!@#$%^&*()_+=`{}\[\]\|\\:;'<>,.\/? ])+/g,"-").replace(/^(-)+|(-)+$/g,"");action="/"+stringFormatter.toLowerCase()+restString;}newContent.append('<div class="type-line"><a href="'+this._options.searchUrl+action+'" rel="external">'+ancestorsStr+this.highlightMatched(text)+"</a>"+"&nbsp("+count+")</div>");}}if(dimResultGroup!=null&&dimResultGroup.displayName=="product.typeahead_prodTitle_prodId"){for(var j=0;j<dimResultGroup.dimensionSearchValues.length;j++){var dimResult=dimResultGroup.dimensionSearchValues[j];var count=dimResult.count;var text=dimResult.label;var number=text.split("|");if(text!=null){var navAction=number[0];var action=number[1];var imgURL=number[2];var replaceurl="";if(imgURL!="null"&&imgURL!=undefined){replaceurl=imgURL;}else{var replaceurl=create_url("sm",navAction);}var stringFormatter=action.replace(/([~!@#$%^&*()_+=`{}\[\]\|\\:;'<>,.\/? ])+/g,"-").replace(/^(-)+|(-)+$/g,"");stringFormatter=stringFormatter.toLowerCase();newContent.append('<div class="type-line"><img id="ahead_'+navAction+'" src="'+replaceurl+'"/><a href="'+this._options.contextPath+"/"+stringFormatter+"/"+navAction+'?typeahead=yes" rel="external">'+this.highlightMatched(action)+"</a>"+"</div>");checkimag(navAction,replaceurl);}}}}}function checkimag(navAction,replaceurl){var ImageObject=new Image();ImageObject.src=replaceurl;ImageObject.onload=function(){$("#ahead_"+navAction).attr("src",replaceurl);};ImageObject.onerror=function(){replaceurl="/assets/images/fillers/filler_REC.gif";$("#ahead_"+navAction).attr("src",replaceurl);};}var searchTerm=$.trim(this._element.val());var filter=$("#combo option:selected").val();var N=0;if(filter!=null){N=filter;}newContent.append('<div class="type-line" id="type-ver-todos"><a href="'+this._options.searchUrl+"?s="+searchTerm+'" rel="external">'+"&nbsp;"+"Ver todos los resultados &gt;&gt;"+"</a>"+"</div >");if(newContent!=null){return newContent[0];}return null;};$.EndecaSearchSuggestor.prototype.highlightMatched=function(text){var inputText=$.trim(this._element.val()).toLowerCase();if(text!=null){var highlighted=text.toLowerCase();}if(highlighted!=null&&highlighted.indexOf(inputText)!=-1){var index=highlighted.indexOf(inputText);var prefix=text.substring(0,index);var suffix=text.substring(index+inputText.length);inputText=text.substr(index,inputText.length);highlighted=prefix+"<span>"+inputText+"</span>"+suffix;}return highlighted;};$.EndecaSearchSuggestor.prototype.bindEventHandler=function(){var suggestor=this;$("#typeahead",this._container).mouseover(function(e){$("#typeahead",suggestor._container).removeClass("selected");$(this).addClass("selected");suggestor._selectedIndex=$("#typeahead",suggestor._container).index($(this));});$("#typeahead",this._container).click(function(e){suggestor.selectItem();});$("a",$("#typeahead",this._container)).click(function(e){e.preventDefault();suggestor.selectItem();});$("#typeahead",this._container).click(function(){clearTimeout(suggestor._hideTimeOutId);suggestor._element.focus();});};$.EndecaSearchSuggestor.prototype.setPosition=function(){var offset=this._element.offset();this._container.css({top:offset.top+this._element.outerHeight(),left:offset.left,width:this._element.width()});};$.fn.endecaSearchSuggest=function(options){var opts=$.extend({},$.fn.endecaSearchSuggest.defaults,options);this.each(function(){var element=$(this);new $.EndecaSearchSuggestor(element,opts);});};$.fn.endecaSearchSuggest.defaults={minAutoSuggestInputLength:3,displayImage:false,delay:250,autoSuggestServiceUrl:"",searchUrl:"",containerClass:"typeahead",defaultImage:"no_image.gif"};})(jQuery);$(document).ready(function(){$("html").click(function(event){if($(".dummy-search").has($(event.target)).length==0){$("#typeahead").hide();}});});